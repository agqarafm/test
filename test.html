<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mükəmməl Hesablayıcı • Lokal Yaddaş</title>
  <style>
    /* Global CSS Dəyişənləri */
    :root{
      --bg: #0c1021;              /* Dərin Fon */
      --panel: #161c33;           /* Panel Fonu */
      --panel-2: #1c2443;         /* Panel İkinci Fon */
      --text: #e8eeff;            /* Əsas Mətn */
      --muted: #aeb4c9;           /* İkinci Mətn */
      --primary: #5d7aff;         /* Vurğu Rəngi (Mavi) */
      --primary-2: #849aff;
      --success: #17c964;         /* Uğur (Yaşıl) */
      --danger: #ff5757;          /* Təhlükə (Qırmızı) */
      --warning: #ffb74d;         /* Xəbərdarlıq (Sarı) */
      --ring: #5d7aff55;          /* Fokus Halqası */
      --shadow: 0 12px 30px rgba(0,0,0,.4), 0 8px 16px rgba(10, 15, 30, .6);
      --radius: 20px;
    }

    /* Reset & Əsas Stil */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, sans-serif;
      background: radial-gradient(1400px 700px at 10% -10%, #202d5a 0%, transparent 60%),
                  radial-gradient(1400px 700px at 90% -10%, #3a205a 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      line-height:1.6;
    }

    .container{ max-width:1200px; margin:40px auto; padding:0 20px; }

    /* Header / Navigasiya */
    .nav{
      position:sticky; top:16px; z-index:50;
      display:flex; gap:15px; align-items:center; justify-content:space-between;
      background:rgba(22, 28, 51, 0.75); /* Yarı-şəffaf fon */
      border:1px solid #33406f;
      box-shadow: var(--shadow);
      padding:14px 20px; border-radius: calc(var(--radius) + 8px);
      backdrop-filter:saturate(1.8) blur(10px); /* Güclü Blur */
    }
    .brand{ display:flex; gap:12px; align-items:center; font-weight:800; font-size:1.4em; letter-spacing:.5px; }
    .brand svg{ filter: drop-shadow(0 6px 10px rgba(93, 122, 255,.3)); }
    .tabs{ display:flex; gap:10px; }

    .tab{
      position:relative; isolation:isolate;
      display:inline-flex; align-items:center; gap:10px; 
      padding:14px 20px; border-radius: 999px; cursor:pointer;
      background: #10152a; border:1px solid #2d3b6a; color:var(--text);
      transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
      user-select:none; font-weight:600;
      box-shadow: inset 0 0 0 0 rgba(93, 122, 255,.0);
    }
    .tab:hover{ transform: translateY(-2px); border-color:#4a62b6; box-shadow: inset 0 0 30px #5d7aff1a; }
    .tab.active{ border-color:var(--primary); box-shadow: inset 0 0 40px #5d7aff30, 0 4px 15px rgba(0,0,0,.2); }

    /* Parıltı effekti */
    .tab .pill{
      position:absolute; inset:auto 10px -10px auto; 
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
      width: 24px; height: 24px; border-radius:999px; opacity:0; transform: translateY(8px) scale(.5);
      transition: .4s cubic-bezier(.175, .885, .32, 1.275);
      box-shadow: 0 8px 20px rgba(93, 122, 255,.65);
      z-index:-1;
    }
    .tab:hover .pill, .tab.active .pill{ opacity:1; transform: translateY(0) scale(1); }


    /* Açılan panel (Menyu content) */
    .dropdown{ position:relative; margin-top:20px; }

    .panel{
      overflow:hidden; 
      max-height:0; opacity:0; transform: translateY(-10px) scale(.98);
      transition: max-height .6s cubic-bezier(.2, .8, .2, 1), opacity .5s ease, transform .5s ease;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid #33406f; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panel.open{ max-height: 2000px; opacity:1; transform: translateY(0) scale(1); }

    .panel-inner{ padding: 25px; display:grid; gap:22px; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 992px){ .col-4, .col-6{ grid-column: span 6; } }
    @media (max-width: 640px){ .col-4, .col-6{ grid-column: span 12; } }

    .card{
      background: #141b38; border:1px solid #2d3b6a; border-radius: calc(var(--radius) - 8px);
      padding:18px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }

    .headline{ font-size:22px; font-weight:800; margin:0 0 8px; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:14px; margin-bottom:12px; display:block; }
    .muted.note-date{ font-size:12px; margin-top:4px; }

    label{ display:block; font-weight:700; margin-bottom:8px; color:var(--primary-2); font-size:15px; }

    .input, textarea{
      width:100%; padding:14px 16px; border-radius:14px; outline:none; 
      background:#0f152d; color:var(--text); font-size:16px; border:1px solid #2d3b6a;
      transition: box-shadow .2s ease, border-color .2s ease, transform .1s ease;
      font-variant-numeric: tabular-nums; /* Rəqəmlərin düzgün hizalanması */
    }
    .input:focus, textarea:focus{ border-color:var(--primary); box-shadow: 0 0 0 8px var(--ring); }
    textarea{ resize:vertical; }

    .row{ display:flex; gap:12px; align-items:center; }
    .row.split{ justify-content:space-between; }

    /* Düymələr */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px; 
      padding:14px 20px; border-radius:14px; cursor:pointer; border:1px solid #4a62b6; 
      background:linear-gradient(180deg,#24346c,#17214a); color:var(--text); font-weight:700;
      transition: transform .15s ease, filter .2s ease, box-shadow .2s ease, border-color .2s ease; 
      min-width:120px;
    }
    .btn:hover{ filter:brightness(1.1); border-color:var(--primary); box-shadow: 0 12px 28px #5d7aff33; }
    .btn:active{ transform: translateY(2px) scale(.98); }

    .btn.ghost{ background:#141b38; border-color:#2d3b6a; font-weight:600; min-width:auto; }
    .btn.danger{ border-color:var(--danger); background:#4f2222; }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #33406f; background:#141b38; color:var(--muted); }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(4,8,20,.7); display:none; align-items:center; justify-content:center; z-index:100; backdrop-filter: blur(4px); }
    .modal-backdrop.show{ display:flex; animation: fadeIn .2s ease; }
    .modal{
      width:min(600px, calc(100vw - 32px));
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--primary); border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      transform: translateY(10px) scale(.97); opacity:0; animation: pop .25s ease forwards;
    }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:18px 20px; border-bottom:1px solid #33406f; }
    .modal-title{ font-weight:800; font-size:1.2em; letter-spacing:.5px; }
    .modal-body{ padding:20px; }

    .modal-result-row{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
      padding: 6px 0;
    }
    .modal-result-row span{ font-size:16px; }
    .modal-result-row strong{ font-size:18px; font-weight:700; }
    .modal-result-row.total{ border-top:1px dashed #33406f; margin-top:15px; padding-top:15px; font-size:20px; font-weight:800; }
    .modal-result-row.debt span{ color: var(--danger); }
    .modal-result-row.credit span{ color: var(--success); }

    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    @keyframes pop{ to{ transform: translateY(0) scale(1); opacity:1 } }

    /* Toast */
    .toast{ position:fixed; right:20px; bottom:20px; background:#141b38; border:1px solid var(--primary); color:var(--text); padding:14px 18px; border-radius:14px; box-shadow: var(--shadow); opacity:0; transform: translateY(10px); transition:.3s; z-index:120; }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Qeydlər listi */
    .notes-list{ display:grid; gap:12px; }
    .note-item{ 
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:start; 
      background:#111730; border:1px solid #2d3b6a; border-radius:14px; padding:16px; 
    }
    .note-content{ width:100%; }
    .note-title{ font-weight:700; font-size:16px; margin-bottom:4px; }
    .note-text{ 
      width:100%; border:none; background:transparent; color:var(--text); font-size:15px; 
      line-height:1.5; padding:0; outline:none; resize:none; overflow:hidden;
    }
    .note-actions{ display:flex; flex-direction:column; gap:8px; }

  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand" title="Tam işlək yerli yaddaşlı tətbiq">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.3L12 14.77 7.22 16.68l.91-5.3L4.27 7.62l5.34-.78L12 2z" fill="url(#g)"/>
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
              <stop stop-color="#5d7aff"/><stop offset="1" stop-color="#849aff"/>
            </linearGradient>
          </defs>
        </svg>
        <div>Mükəmməl Hesablayıcı</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Menyu">
        <button class="tab active" data-target="#tab-kart" role="tab" aria-selected="true">
          <span class="label">Kart Məbləğ</span>
          <span class="pill"></span>
        </button>
        <button class="tab" data-target="#tab-smart" role="tab" aria-selected="false">
          <span class="label">Smart Qalıq</span>
          <span class="pill"></span>
        </button>
        <button class="tab" data-target="#tab-notes" role="tab" aria-selected="false">
          <span class="label">Qeydlər</span>
          <span class="pill"></span>
        </button>
      </div>
    </nav>

    <div class="dropdown">
      <section id="tab-kart" class="panel open" aria-hidden="false">
        <div class="panel-inner">
          <div class="headline">Kart Məbləğləri və Borc Hesablayıcısı</div>
          <span class="muted">Aidə, Gülşad və Arzu üçün məbləğləri daxil edin. Daxil edilən dəyərlər yerli yaddaşda saxlanılır.</span>

          <div class="grid">
            <div class="col-4">
              <div class="card">
                <label for="aide">Aidə (Məbləğ)</label>
                <input id="aide" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-4">
              <div class="card">
                <label for="gulshad">Gülşad (Məbləğ)</label>
                <input id="gulshad" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-4">
              <div class="card">
                <label for="arzu">Arzu (Məbləğ)</label>
                <input id="arzu" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-12 row split">
              <div class="tag" id="kart-status">Avtoyaddaş aktivdir</div>
              <div class="row">
                <button class="btn" id="btn-kart-calc">Hesabla & Fərqi Tap</button>
                <button class="btn ghost danger" id="btn-kart-reset" title="Məbləğləri sıfırla">Sıfırla</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="dropdown">
      <section id="tab-smart" class="panel" aria-hidden="true">
        <div class="panel-inner">
          <div class="headline">Smart Qalıq və Fərq Hesablayıcısı</div>
          <span class="muted">2 nağd və 2 kart məbləğini daxil edin. Sistem cəmi və nağd/kart arasındakı fərqi tapacaq.</span>

          <div class="grid">
            <div class="col-6">
              <div class="card">
                <label for="cash1">Nağd Məbləğ 1</label>
                <input id="cash1" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="cash2">Nağd Məbləğ 2</label>
                <input id="cash2" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="card1">Kart Məbləği 1</label>
                <input id="card1" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="card2">Kart Məbləği 2</label>
                <input id="card2" class="input" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" />
              </div>
            </div>
            <div class="col-12 row split">
              <div class="tag" id="smart-status">Avtoyaddaş aktivdir</div>
              <div class="row">
                <button class="btn" id="btn-smart-calc">Hesabla & Fərqi Tap</button>
                <button class="btn ghost danger" id="btn-smart-reset" title="Dəyərləri sıfırla">Sıfırla</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="dropdown">
      <section id="tab-notes" class="panel" aria-hidden="true">
        <div class="panel-inner">
          <div class="headline">Təkmil Gündəlik Qeydlər</div>
          <span class="muted">Qeydlərinizi başlıq və mətnlə daxil edin. Hər qeydin tarixi avtomatik qeyd olunur.</span>

          <div class="card">
            <label for="note-title">Başlıq (İstəyə bağlı)</label>
            <input id="note-title" class="input" placeholder="Məsələn: Ödənişlər" />
            <label for="note-text" style="margin-top:15px;">Yeni Qeyd Mətni</label>
            <textarea id="note-text" class="input" rows="4" placeholder="Məsələn: 02.09.2025 üçün plan: 10:00 Görüş, 14:00 Məhsul göndərişi..."></textarea>
            <div class="row split" style="margin-top:15px;">
              <div class="tag" id="notes-status">Avtoyaddaş aktivdir</div>
              <button class="btn" id="add-note">Qeydi Əlavə Et</button>
            </div>
          </div>

          <div class="notes-list" id="notes-list" aria-live="polite"></div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Nəticə</div>
        <button class="btn ghost" id="modal-close">Bağla</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <div class="toast" id="toast">Yadda saxlanıldı</div>

  <script>
    // ==========================================================
    // UTIL FUNKSİYALARI
    // ==========================================================

    // Rəqəmi təmizləyib float edir (Boş və ya qeyri-rəqəm dəyərləri 0 qaytarır)
    const toNum = (v)=>{
      if(v == null || v === '') return 0;
      // Boşluqları silir, vergülləri nöqtəyə çevirir (decimal üçün)
      const s = String(v).replace(/\s+/g,'').replace(/,/g,'.');
      const n = parseFloat(s);
      // Yalnız sonlu rəqəm olduqda onu qaytarır
      return Number.isFinite(n) ? n : 0;
    };
    
    // Rəqəmi AZ formatında (iki onluq, boşluqla) formatlayır
    const fmt = (n)=> new Intl.NumberFormat('az-AZ', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n||0);
    
    // Tarixi qısa və oxunaqlı formata çevirir
    const fmtDate = (timestamp)=> new Date(timestamp).toLocaleString('az-AZ', {
        day: '2-digit', month: '2-digit', year: 'numeric', 
        hour: '2-digit', minute: '2-digit'
    });

    // Yaddaş (Local Storage) köməkçiləri
    const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k, d)=> { 
        try{ 
            const v = JSON.parse(localStorage.getItem(k)); 
            return v ?? d 
        }catch(e){ 
            console.error('Yaddaşdan yükləmə xətası:', e);
            return d 
        } 
    };

    // Toast bildirişi
    let toastTimer;
    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove('show'), 1600);
    }

    // Modal pəncərəsi
    const modal = {
      open(title, html){
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = html;
        const bd = document.getElementById('modal-backdrop');
        bd.classList.add('show');
        bd.setAttribute('aria-hidden','false');
      },
      close(){
        const bd = document.getElementById('modal-backdrop');
        bd.classList.remove('show');
        bd.setAttribute('aria-hidden','true');
      }
    };

    // ==========================================================
    // UI İdarəetmə (Tabs, Modal)
    // ==========================================================
    
    // Tab navigasiyası
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');

        const target = tab.getAttribute('data-target');
        document.querySelectorAll('.panel').forEach(p=>{
          const isTarget = '#'+p.id === target;
          p.classList.toggle('open', isTarget);
          p.setAttribute('aria-hidden', String(!isTarget));
        });
      });
    });

    // Modal bağlama
    document.getElementById('modal-close').addEventListener('click', modal.close);
    document.getElementById('modal-backdrop').addEventListener('click', (e)=>{ if(e.target.id==='modal-backdrop') modal.close(); });
    
    // Rəqəm girişlərini yalnız rəqəm (və ya vergül/nöqtə) ilə məhdudlaşdırmaq
    document.querySelectorAll('input[inputmode="decimal"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            // Rəqəmlər (0-9) və nöqtə/vergülə icazə verilir
            if (/[^0-9.,]/.test(e.key)) {
                e.preventDefault();
            }
            // Yalnız bir nöqtəyə və ya vergülə icazə verilir
            if ((e.key === '.' || e.key === ',') && (this.value.includes('.') || this.value.includes(','))) {
                e.preventDefault();
            }
        });
    });


    // ==========================================================
    // KART MƏBLƏĞ FUNKSİONALLIĞI
    // ==========================================================
    const idsKart = ['aide','gulshad','arzu'];
    const keyKart = 'kartAmounts.v2'; // Versiya yeniləndi

    function loadKart(){
      const st = load(keyKart, {aide:'', gulshad:'', arzu:''});
      idsKart.forEach(id=>{ document.getElementById(id).value = st[id] ?? '' });
      document.getElementById('kart-status').textContent = 'Avtoyaddaş aktivdir';
    }

    function persistKart(){
      const st = Object.fromEntries(idsKart.map(id=>[id, document.getElementById(id).value || '' ]));
      save(keyKart, st); 
      document.getElementById('kart-status').textContent = 'Son yaddaş: ' + new Date().toLocaleTimeString('az-AZ');
    }

    // Input hadisələri
    idsKart.forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', persistKart);
    });

    // Hesablama
    document.getElementById('btn-kart-calc').addEventListener('click', ()=>{
      const vals = idsKart.map(id=> ({ 
          name: document.querySelector(`label[for="${id}"]`).textContent.split(' ')[0], 
          value: toNum(document.getElementById(id).value) 
      }));
      const sum = vals.reduce((a,b)=>a+b.value,0);
      
      if (sum === 0) {
        toast('Məbləğ daxil edilməyib.');
        return;
      }
      
      const count = vals.filter(v => v.value > 0).length || 1; // ən az 1ə bölmək üçün
      const average = sum / vals.length; // Hər kəsin iştirakçı olduğu fərz edilir

      let detail = `
        <div class="modal-result-row">
          <span>Ümumi Xərc (Cəm)</span><strong>${fmt(sum)}</strong>
        </div>
        <div class="modal-result-row" style="color:var(--primary); font-weight:700;">
          <span>Orta Məbləğ (Hər adama)</span><strong>${fmt(average)}</strong>
        </div>
        <hr style="border:0; border-top:1px solid #33406f; margin:15px 0 10px;"/>
        <p class="muted" style="margin-bottom:15px;">**Fərq:** Müsbət rəqəm o deməkdir ki, o qədər pul almalıdır (ortaqdan artıq xərcləyib). Mənfi rəqəm isə o qədər borcludur.</p>
      `;

      // Fərqlərin hesablanması (Borc/Alacaq)
      vals.forEach(v => {
        const diff = v.value - average;
        const className = diff < 0 ? 'debt' : 'credit';
        const label = diff < 0 ? 'Borcludur' : 'Alacaq';
        const sign = diff > 0 ? '+' : '';

        detail += `
          <div class="modal-result-row ${className}">
            <span>${v.name} (${label})</span><strong>${sign}${fmt(diff)}</strong>
          </div>
        `;
      });

      modal.open('Kart Məbləğ — Ətraflı Nəticə', detail);
    });

    // Sıfırlama
    document.getElementById('btn-kart-reset').addEventListener('click', ()=>{
      if(confirm('Əminsiniz? Bütün Kart Məbləğləri sıfırlanacaq.')){
        idsKart.forEach(id=> document.getElementById(id).value = '');
        persistKart();
        toast('Kart Məbləğləri sıfırlandı');
      }
    });

    // ==========================================================
    // SMART QALIQ FUNKSİONALLIĞI
    // ==========================================================
    const idsSmart = ['cash1','cash2','card1','card2'];
    const keySmart = 'smartValues.v2'; // Versiya yeniləndi

    function loadSmart(){
      const st = load(keySmart, {cash1:'', cash2:'', card1:'', card2:''});
      idsSmart.forEach(id=>{ document.getElementById(id).value = st[id] ?? '' });
      document.getElementById('smart-status').textContent = 'Avtoyaddaş aktivdir';
    }

    function persistSmart(){
      const st = Object.fromEntries(idsSmart.map(id=>[id, document.getElementById(id).value || '' ]));
      save(keySmart, st); 
      document.getElementById('smart-status').textContent = 'Son yaddaş: ' + new Date().toLocaleTimeString('az-AZ');
    }

    idsSmart.forEach(id=>{
      document.getElementById(id).addEventListener('input', persistSmart);
    });

    // Hesablama
    document.getElementById('btn-smart-calc').addEventListener('click', ()=>{
      const v = Object.fromEntries(idsSmart.map(id=>[id, toNum(document.getElementById(id).value)]));
      const sumCash = v.cash1 + v.cash2; 
      const sumCard = v.card1 + v.card2; 
      const total = sumCash + sumCard;
      const difference = Math.abs(sumCash - sumCard);
      const diffLabel = sumCash >= sumCard ? 'Nağd Kartdan Çoxdur (+)' : 'Kart Nağddan Çoxdur (-)';
      const diffClass = sumCash >= sumCard ? 'credit' : 'debt';

      if (total === 0) {
        toast('Məbləğ daxil edilməyib.');
        return;
      }

      const html = `
        <div class="modal-result-row">
          <span>Nağd Məbləğ 1 + 2</span><strong>${fmt(sumCash)}</strong>
        </div>
        <div class="modal-result-row">
          <span>Kart Məbləği 1 + 2</span><strong>${fmt(sumCard)}</strong>
        </div>
        <hr style="border:0; border-top:1px dashed #33406f; margin:12px 0;"/>
        <div class="modal-result-row total">
          <span>Yekun (Total)</span><strong>${fmt(total)}</strong>
        </div>
        <hr style="border:0; border-top:1px solid #33406f; margin:15px 0 10px;"/>
        <div class="modal-result-row ${diffClass}" style="font-weight:700;">
          <span>Nağd / Kart Fərqi</span><strong>${(sumCash < sumCard ? '-' : '+') + fmt(difference)}</strong>
        </div>
        <span class="muted" style="display:block; margin-top:5px;">${diffLabel}</span>
        `;
      modal.open('Smart Qalıq — Nəticə', html);
    });

    // Sıfırlama
    document.getElementById('btn-smart-reset').addEventListener('click', ()=>{
      if(confirm('Əminsiniz? Bütün Smart Qalıq dəyərləri sıfırlanacaq.')){
        idsSmart.forEach(id=> document.getElementById(id).value = '');
        persistSmart();
        toast('Smart Qalıq dəyərləri sıfırlandı');
      }
    });

    // ==========================================================
    // QEYDLƏR FUNKSİONALLIĞI
    // ==========================================================
    const keyNotes = 'notes.v2'; // Versiya yeniləndi

    // Qeyd elementinin yaratılması və render edilməsi
    function renderNotes(){
      const listEl = document.getElementById('notes-list');
      const items = load(keyNotes, []);
      if(!items.length){ listEl.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">Hələ qeyd yoxdur. İlk qeydinizi əlavə edin.</div>'; return; }
      listEl.innerHTML = '';
      
      // Ən yeni qeyd yuxarıda olsun
      items.sort((a, b) => b.createdAt - a.createdAt);

      for(const note of items){
        const wrap = document.createElement('div'); wrap.className='note-item'; wrap.dataset.id = note.id;
        
        const content = document.createElement('div'); content.className='note-content';
        const titleEl = document.createElement('div'); titleEl.className='note-title'; titleEl.textContent = note.title || 'Başlıqsız Qeyd';
        const dateEl = document.createElement('div'); dateEl.className='muted note-date'; dateEl.textContent = fmtDate(note.createdAt);
        
        const textarea = document.createElement('textarea'); textarea.className='note-text'; 
        textarea.rows=Math.max(2, note.text.split('\n').length); 
        textarea.value = note.text; 
        textarea.disabled = true;
        
        content.append(titleEl, dateEl, textarea);

        const actions = document.createElement('div'); actions.className='note-actions';
        const btnEdit = document.createElement('button'); btnEdit.className='btn ghost'; btnEdit.textContent='Düzəliş';
        const btnSave = document.createElement('button'); btnSave.className='btn'; btnSave.textContent='Yadda saxla'; btnSave.style.display='none';
        const btnDelete = document.createElement('button'); btnDelete.className='btn ghost danger'; btnDelete.textContent='Sil';
        actions.append(btnEdit, btnSave, btnDelete);
        
        wrap.append(content, actions); listEl.appendChild(wrap);
        
        // Textarea hündürlüyünü məzmuna uyğun tənzimləmək
        const adjustHeight = () => {
             textarea.style.height = 'auto'; // Reset
             textarea.style.height = textarea.scrollHeight + 4 + 'px'; // Yeni hündürlük
        };
        adjustHeight();
        textarea.addEventListener('input', adjustHeight);


        // Düzəliş düyməsi
        btnEdit.addEventListener('click', ()=>{ 
            textarea.disabled = false; textarea.focus(); 
            btnEdit.style.display='none'; btnSave.style.display='inline-flex'; 
        });
        
        // Yadda saxla düyməsi
        btnSave.addEventListener('click', ()=>{
          textarea.disabled = true; btnSave.style.display='none'; btnEdit.style.display='inline-flex';
          const all = load(keyNotes, []);
          const idx = all.findIndex(x=> x.id === note.id);
          if(idx>-1){ 
            all[idx].text = textarea.value; 
            // Başlıq dəyişikliyini burada nəzərə almırıq, çünki Başlıq inputu ayrıdır.
            save(keyNotes, all); toast('Qeyd yeniləndi');
          }
        });
        
        // Sil düyməsi
        btnDelete.addEventListener('click', ()=>{
          if(confirm('Əminsiniz? Bu qeyd silinəcək: "' + (note.title || note.text.substring(0, 30)) + '"')){
            const all = load(keyNotes, []);
            save(keyNotes, all.filter(x=> x.id !== note.id));
            renderNotes(); 
            toast('Qeyd silindi');
          }
        });
      }
    }

    // Yeni qeyd əlavə etmək
    document.getElementById('add-note').addEventListener('click', ()=>{
      const t = document.getElementById('note-text');
      const text = t.value.trim(); 
      const title = document.getElementById('note-title').value.trim();
      
      if(!text){ toast('Qeyd mətni boş ola bilməz'); return; }
      
      const all = load(keyNotes, []);
      all.push({ 
          id: 'n'+Date.now(), 
          title: title, 
          text: text, 
          createdAt: Date.now() 
      });
      
      save(keyNotes, all); 
      t.value=''; 
      document.getElementById('note-title').value = '';
      renderNotes(); 
      toast('Yeni qeyd əlavə olundu');
    });

    // ==========================================================
    // İLK YÜKLƏNMƏ
    // ==========================================================
    (function init(){
      loadKart(); 
      loadSmart(); 
      renderNotes();
    })();
  </script>
</body>
</html>
