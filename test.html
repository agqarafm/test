<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kart məbləğ • Smart qalıq • Qeydlər</title>
  <style>
    :root{
      --bg:#0b1020;            /* dərin fon */
      --panel:#131a2e;         /* panel fonu */
      --panel-2:#0f1528;       /* açılan panel kölgəsi */
      --text:#e8eeff;          /* əsas mətn */
      --muted:#9fb0ffb3;       /* ikinci dərəcəli mətn */
      --primary:#6b8bff;       /* vurğu */
      --primary-2:#86a3ff;     /* hover */
      --ring:#a2b6ff55;        /* fokus halqası */
      --success:#17c964;
      --danger:#ff4d4f;
      --warning:#f5a524;
      --shadow: 0 10px 25px rgba(0,0,0,.35), 0 6px 12px rgba(8,15,40,.5);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, #1a2550 0%, transparent 55%),
                  radial-gradient(1200px 600px at 90% -10%, #271a50 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.3L12 14.77 7.22 16.68l.91-5.3L4.27 7.62l5.34-.78L12 2z" fill="%23e8eeff" stroke="none"/></svg>') 12 12, auto;
    }

    .container{ max-width:1100px; margin:40px auto; padding:0 16px; }

    /* Header / Menyu çubuğu */
    .nav{
      position:sticky; top:10px; z-index:50;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, #121a32 0%, #0f1528 100%);
      border:1px solid #233056;
      box-shadow: var(--shadow);
      padding:12px; border-radius: calc(var(--radius) + 6px);
      backdrop-filter:saturate(1.2) blur(6px);
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:700; letter-spacing:.2px; }
    .brand svg{ filter: drop-shadow(0 6px 10px rgba(107,139,255,.25)); }

    .tabs{ display:flex; gap:8px; }

    .tab{
      position:relative; isolation:isolate;
      display:inline-flex; align-items:center; gap:10px; 
      padding:12px 16px; border-radius: 999px; cursor:pointer;
      background: #0d1326;
      border:1px solid #223057; color:var(--text);
      transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
      user-select:none;
      box-shadow: inset 0 0 0 0 rgba(107,139,255,.0);
    }
    .tab:hover{ transform: translateY(-1px); border-color:#2a3b70; box-shadow: inset 0 0 24px #6b8bff14; }
    .tab.active{ border-color:#3b57a8; box-shadow: inset 0 0 32px #6b8bff26; }
    .tab:focus-visible { outline: 3px solid var(--ring); outline-offset: 2px; }

    .tab .pill{
      position:absolute; inset:auto 8px -8px auto; 
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
      width: 22px; height: 22px; border-radius:999px; opacity:0; transform: translateY(6px) scale(.6);
      transition: .35s ease;
      box-shadow: 0 6px 18px rgba(107,139,255,.55);
      z-index:-1;
    }
    .tab:hover .pill, .tab.active .pill{ opacity:.9; transform: translateY(0) scale(1); }

    .tab .label{ font-weight:600; letter-spacing:.2px; }

    /* Açılan panel (menyu) */
    .dropdown{
      position:relative; margin-top:14px;
    }

    .panel{
      overflow:hidden; 
      max-height:0; opacity:0; transform: translateY(-8px) scale(.98);
      transition: max-height .5s cubic-bezier(.2,.8,.2,1), opacity .4s ease, transform .4s ease;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid #223057; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .panel.open{ max-height: 1000px; opacity:1; transform: translateY(0) scale(1); }

    .panel-inner{ padding: 22px; display:grid; gap:18px; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 860px){ .col-4, .col-6, .col-8{ grid-column: span 12; } }

    .card{
      background: #0e1530; border:1px solid #223057; border-radius: calc(var(--radius) - 6px);
      padding:16px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    .headline{ font-size:18px; font-weight:700; margin:2px 0 10px; }
    .muted{ color:var(--muted); font-size:13px; }

    label{ display:flex; gap:8px; align-items:center; font-weight:600; margin-bottom:6px; }

    .input{
      width:100%; padding:12px 14px; border-radius:12px; outline:none; 
      background:#0c1327; color:var(--text); font-size:15px; border:1px solid #223057;
      transition: box-shadow .2s ease, border-color .2s ease, transform .1s ease, background .2s ease;
      font-variant-numeric: tabular-nums; /* Rəqəmlərin düzülüşünü sabit saxlayır */
    }
    .input:focus{ border-color:#3a57a8; box-shadow: 0 0 0 6px var(--ring); }
    .input:enabled { border-color:#3a57a8; }
    .input:enabled:focus{ background: #131a34; }

    .row{ display:flex; gap:10px; align-items:center; }

    .btn{
      display:inline-flex; align-items:center; gap:10px; 
      padding:12px 16px; border-radius:12px; cursor:pointer; border:1px solid #2a3b70; 
      background:linear-gradient(180deg,#17224a,#111a36); color:var(--text); font-weight:700;
      transition: transform .12s ease, filter .2s ease, box-shadow .2s ease, border-color .2s ease; 
    }
    .btn:hover{ filter:brightness(1.1); border-color:#3b57a8; box-shadow: 0 10px 24px #6b8bff22; }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:focus-visible { outline: 3px solid var(--ring); outline-offset: 2px; }

    .btn.ghost{ background:#0c1327; border-color:#25325b; font-weight:600; }

    .tag{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #233056; background:#0e1530; color:var(--muted); }
    .tag .date-stamp{ color:var(--primary-2); font-weight: 500;}

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(4,8,20,.6); display:none; align-items:center; justify-content:center; z-index:100; }
    .modal-backdrop.show{ display:flex; animation: fadeIn .18s ease; }
    .modal{
      width:min(560px, calc(100vw - 28px));
      background: linear-gradient(180deg, #121a32 0%, #0f1528 100%);
      border:1px solid #2a3b70; border-radius: calc(var(--radius) + 2px);
      box-shadow: var(--shadow);
      transform: translateY(8px) scale(.98); opacity:0; animation: pop .2s ease forwards;
      will-change: transform, opacity;
    }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #24325d; }
    .modal-title{ font-weight:800; letter-spacing:.2px; }
    .modal-body{ padding:16px; }

    /* Nəticənin vizual vurğulanması */
    .result-total{
        font-size: 20px; font-weight: 800;
        background: -webkit-linear-gradient(90deg, var(--primary), var(--primary-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: .5px;
    }

    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    @keyframes pop{ to{ transform: translateY(0) scale(1); opacity:1 } }

    /* Toast */
    .toast{ position:fixed; right:16px; bottom:16px; background:#0e1530; border:1px solid #2a3b70; color:var(--text); padding:12px 14px; border-radius:12px; box-shadow: var(--shadow); opacity:0; transform: translateY(8px); transition:.25s; z-index:120; }
    .toast.show{ opacity:1; transform: translateY(0); }

    /* Qeydlər listi */
    .notes-list{ display:grid; gap:10px; }
    .note-item{ 
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:start; 
      background:#0c1327; border:1px solid #233056; border-radius:12px; padding:12px; 
    }
    .note-content{ display:flex; flex-direction: column; gap: 8px; }
    .note-actions{ display:flex; gap:8px; }

    /* Kiçik dekorativ parıltı */
    .glow{ position:absolute; inset:auto auto -14px 12px; width:140px; height:36px; background: radial-gradient(60px 22px at 30% 30%, #86a3ff77, transparent 70%); filter: blur(10px); pointer-events:none; opacity:.35; }

  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="brand" title="Tam işlək yerli yaddaşlı tətbiq">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.3L12 14.77 7.22 16.68l.91-5.3L4.27 7.62l5.34-.78L12 2z" fill="url(#g)"/>
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="24" y2="24" gradientUnits="userSpaceOnUse">
              <stop stop-color="#6b8bff"/><stop offset="1" stop-color="#86a3ff"/>
            </linearGradient>
          </defs>
        </svg>
        <div>Hesablayıcı Tətbiq</div>
      </div>
      <div class="tabs" role="tablist" aria-label="Menyu">
        <button class="tab active" data-target="#tab-kart" role="tab" aria-selected="true">
          <span class="label">Kart məbləğ</span>
          <span class="pill" aria-hidden="true"></span>
          <span class="glow" aria-hidden="true"></span>
        </button>
        <button class="tab" data-target="#tab-smart" role="tab" aria-selected="false">
          <span class="label">Smart qalıq</span>
          <span class="pill" aria-hidden="true"></span>
          <span class="glow" aria-hidden="true"></span>
        </button>
        <button class="tab" data-target="#tab-notes" role="tab" aria-selected="false">
          <span class="label">Qeydlər</span>
          <span class="pill" aria-hidden="true"></span>
          <span class="glow" aria-hidden="true"></span>
        </button>
      </div>
    </nav>

    <div class="dropdown">
      <section id="tab-kart" class="panel open" aria-hidden="false">
        <div class="panel-inner">
          <div class="headline">Kart məbləğ</div>
          <div class="muted">Aidə, Gülşad və Arzu üçün məbləğləri daxil edin. Daxil etdiyiniz dəyərlər avtomatik yadda saxlanılır.</div>

          <div class="grid">
            <div class="col-4">
              <div class="card">
                <label for="aide">Aidə (₼)</label>
                <input id="aide" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-4">
              <div class="card">
                <label for="gulshad">Gülşad (₼)</label>
                <input id="gulshad" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-4">
              <div class="card">
                <label for="arzu">Arzu (₼)</label>
                <input id="arzu" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-12 row" style="justify-content:space-between;">
              <div class="tag" id="kart-status">Avtoyaddaş aktivdir</div>
              <div class="row">
                <button class="btn" id="btn-kart-calc">Hesabla</button>
                <button class="btn ghost" id="btn-kart-reset" title="Məbləğləri sıfırla">Sıfırla</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="dropdown">
      <section id="tab-smart" class="panel" aria-hidden="true">
        <div class="panel-inner">
          <div class="headline">Smart qalıq</div>
          <div class="muted">2 nağd və 2 kart məbləğini daxil edin. Dəyərlər avtomatik yadda saxlanılır.</div>

          <div class="grid">
            <div class="col-6">
              <div class="card">
                <label for="cash1">Nağd məbləğ 1 (₼)</label>
                <input id="cash1" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="cash2">Nağd məbləğ 2 (₼)</label>
                <input id="cash2" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="card1">Kart məbləği 1 (₼)</label>
                <input id="card1" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-6">
              <div class="card">
                <label for="card2">Kart məbləği 2 (₼)</label>
                <input id="card2" class="input" inputmode="decimal" placeholder="0.00" />
              </div>
            </div>
            <div class="col-12 row" style="justify-content:space-between;">
              <div class="tag" id="smart-status">Avtoyaddaş aktivdir</div>
              <div class="row">
                <button class="btn" id="btn-smart-calc">Hesabla</button>
                <button class="btn ghost" id="btn-smart-reset" title="Dəyərləri sıfırla">Sıfırla</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="dropdown">
      <section id="tab-notes" class="panel" aria-hidden="true">
        <div class="panel-inner">
          <div class="headline">Qeydlər</div>
          <div class="muted">Gündəlik qeydlərinizi yazın. Qeydlər avtomatik yadda saxlanılır; redaktə və silmə mümkündür.</div>

          <div class="card">
            <label for="note-text">Yeni qeyd</label>
            <textarea id="note-text" class="input" rows="3" placeholder="Məsələn: 02.09.2025 üçün plan..."></textarea>
            <div class="row" style="justify-content:space-between; margin-top:10px;">
              <div class="tag" id="notes-status">Avtoyaddaş aktivdir</div>
              <button class="btn" id="add-note">Qeydi əlavə et</button>
            </div>
          </div>

          <div class="notes-list" id="notes-list" aria-live="polite"></div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Nəticə</div>
        <button class="btn ghost" id="modal-close">Bağla</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <div class="toast" id="toast">Yadda saxlanıldı</div>

  <script>
    // Util: number parse & format
    // Onluq nöqtə və ya vergülü qəbul edir, boşluqları silir.
    const toNum = (v)=>{
      if(v == null) return 0;
      const s = String(v).replace(/\s+/g,'').replace(/,/g,'.');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    };
    
    // Rəqəmi AZ formatında (minlik ayırıcı ilə) və Məzənnə (₼) ilə formatlaşdırır.
    const fmt = (n, currency=true)=> {
        const value = new Intl.NumberFormat('az-AZ', {
            minimumFractionDigits:2, 
            maximumFractionDigits:2,
        }).format(n||0);
        return currency ? `${value} ₼` : value;
    };

    // Util: storage helpers
    const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k, d)=> { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? d }catch{ return d } };

    // Toast
    let toastTimer;
    const toast = (msg)=>{
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove('show'), 1400);
    }

    // Modal
    const modal = {
      open(title, html){
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = html;
        const bd = document.getElementById('modal-backdrop');
        bd.classList.add('show');
        bd.setAttribute('aria-hidden','false');
      },
      close(){
        const bd = document.getElementById('modal-backdrop');
        bd.classList.remove('show');
        bd.setAttribute('aria-hidden','true');
      }
    };

    // Tabs -> açılan panellər (dropdown)
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');

        const target = tab.getAttribute('data-target');
        document.querySelectorAll('.panel').forEach(p=>{
          const isTarget = '#'+p.id === target;
          p.classList.toggle('open', isTarget);
          p.setAttribute('aria-hidden', String(!isTarget));
        });
      });
    });

    // Modal close
    document.getElementById('modal-close').addEventListener('click', modal.close);
    document.getElementById('modal-backdrop').addEventListener('click', (e)=>{ if(e.target.id==='modal-backdrop') modal.close(); });


    /* --- MODULAR HESABLAMA MƏNTİQİ ---  */

    /**
     * Təkrar istifadə oluna bilən Hesablama Modulu yaradır və formatlaşdırmanı idarə edir.
     */
    function createCalculatorModule(ids, key, statusElId, calcButtonId, resetButtonId, modalTitle, calcLogic) {
        function formatInput(inputElement) {
            const num = toNum(inputElement.value);
            // Kursorun yerini itirməmək üçün fokus itəndə formatlaşdırılır
            if(document.activeElement !== inputElement) {
                // Əgər dəyər daxil edilibsə və sıfır deyilsə, formatlaşdır
                inputElement.value = num === 0 ? '' : fmt(num, false);
            }
        }

        function loadState(){
            const st = load(key, Object.fromEntries(ids.map(id => [id, ''])));
            ids.forEach(id => { 
                const el = document.getElementById(id);
                el.value = st[id] ?? '';
                formatInput(el); // Yükləyəndə də formatlaşdır
            });
        }

        function persistState(){
            const st = Object.fromEntries(ids.map(id => {
                const el = document.getElementById(id);
                return [id, el.value || '' ]; 
            }));
            save(key, st); 
            toast('Yadda saxlanıldı');
            document.getElementById(statusElId).textContent = 'Son yaddaş: ' + new Date().toLocaleTimeString('az-AZ');
        }

        // Input hadisələrinin bağlanması (Auto-save)
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', persistState);
            // Fokus itəndə formatlaşdırma tətbiq olunur
            el.addEventListener('blur', (e) => formatInput(e.target));
            // Fokuslananda təmiz rəqəm göstərilir
            el.addEventListener('focus', (e) => {
                const num = toNum(e.target.value);
                e.target.value = num === 0 ? '' : num.toFixed(2);
            });
        });

        // Hesabla düyməsi
        document.getElementById(calcButtonId).addEventListener('click', () => {
            const values = Object.fromEntries(ids.map(id => [id, toNum(document.getElementById(id).value)]));
            const html = calcLogic(values);
            modal.open(modalTitle, html);
        });

        // Sıfırla düyməsi
        document.getElementById(resetButtonId).addEventListener('click', () => {
            ids.forEach(id => document.getElementById(id).value = '');
            persistState();
        });
        
        // Modulu ilkin yüklə
        loadState();
    }


    // KART MƏBLƏĞ Məntiqi 
    createCalculatorModule(
        ['aide','gulshad','arzu'],
        'kartAmounts.v1',
        'kart-status',
        'btn-kart-calc',
        'btn-kart-reset',
        'Kart məbləğ — Yekun',
        (v) => { // calcLogic: Yekun hesabatın HTML-i
            const vals = [v.aide, v.gulshad, v.arzu];
            const sum = vals.reduce((a,b)=>a+b,0);
            return `
                <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                  <span>Aidə</span><strong>${fmt(v.aide)}</strong>
                </div>
                <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                  <span>Gülşad</span><strong>${fmt(v.gulshad)}</strong>
                </div>
                <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                  <span>Arzu</span><strong>${fmt(v.arzu)}</strong>
                </div>
                <hr style="border:0; border-top:1px solid #24325d; margin:12px 0;"/>
                <div class="row" style="justify-content:space-between;">
                  <span>Yekun</span><strong class="result-total">${fmt(sum)}</strong>
                </div>`;
        }
    );

    // SMART QALIQ Məntiqi 
    createCalculatorModule(
        ['cash1','cash2','card1','card2'],
        'smartValues.v1',
        'smart-status',
        'btn-smart-calc',
        'btn-smart-reset',
        'Smart qalıq — Nəticə',
        (v) => { // calcLogic: Yekun hesabatın HTML-i
            const sumCash = v.cash1 + v.cash2; 
            const sumCard = v.card1 + v.card2; 
            const total = sumCash + sumCard;
            return `
                <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                  <span>Nağd məbləğlər</span><strong>${fmt(sumCash)}</strong>
                </div>
                <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                  <span>Kart məbləğləri</span><strong>${fmt(sumCard)}</strong>
                </div>
                <hr style="border:0; border-top:1px solid #24325d; margin:12px 0;"/>
                <div class="row" style="justify-content:space-between;">
                  <span>Yekun</span><strong class="result-total">${fmt(total)}</strong>
                </div>`;
        }
    );


    /* --- QEYDLƏR MƏNTİQİ ---  */

    const keyNotes = 'notes.v1';

    function renderNotes(){
      const listEl = document.getElementById('notes-list');
      const items = load(keyNotes, []);
      
      document.getElementById('notes-status').textContent = 'Qeyd sayı: ' + items.length;

      if(!items.length){ listEl.innerHTML = '<div class="muted">Hələ qeyd yoxdur.</div>'; return; }
      listEl.innerHTML = '';
      
      const dateFormatter = new Intl.DateTimeFormat('az-AZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

      for(const note of items){
        const wrap = document.createElement('div'); wrap.className='note-item'; wrap.dataset.id = note.id;
        
        const content = document.createElement('div'); content.className = 'note-content';

        // Tarix stampı əlavə edilir
        const dateSpan = document.createElement('span'); dateSpan.className = 'tag date-stamp';
        dateSpan.textContent = 'Əlavə edilib: ' + dateFormatter.format(note.createdAt);
        
        const textarea = document.createElement('textarea'); textarea.className='input'; textarea.rows=2; textarea.value = note.text; textarea.disabled = true;
        
        content.append(dateSpan, textarea);

        const actions = document.createElement('div'); actions.className='note-actions';
        
        const btnEdit = document.createElement('button'); btnEdit.className='btn ghost'; btnEdit.textContent='Düzəliş';
        const btnSave = document.createElement('button'); btnSave.className='btn'; btnSave.textContent='Yadda saxla'; btnSave.style.display='none';
        const btnCancel = document.createElement('button'); btnCancel.className='btn ghost'; btnCancel.textContent='Ləğv et'; btnCancel.style.display='none';
        const btnDelete = document.createElement('button'); btnDelete.className='btn ghost'; btnDelete.textContent='Sil';
        
        actions.append(btnEdit, btnSave, btnCancel, btnDelete);
        wrap.append(content, actions); listEl.appendChild(wrap);
        
        // Redaktə rejiminə keçid
        btnEdit.addEventListener('click', ()=>{ 
            textarea.disabled = false; 
            textarea.focus(); 
            btnEdit.style.display='none'; 
            btnSave.style.display='inline-flex'; 
            btnCancel.style.display='inline-flex';
            textarea.dataset.originalText = textarea.value;
            dateSpan.textContent = 'Redaktə edilir...'; // Redaktə statusunu göstər
        });
        
        // Saxla
        btnSave.addEventListener('click', ()=>{
            const newText = textarea.value.trim();
            if(!newText){ toast('Mətn boş ola bilməz'); return; }

            textarea.disabled = true; 
            btnSave.style.display='none'; 
            btnCancel.style.display='none';
            btnEdit.style.display='inline-flex';

            const all = load(keyNotes, []);
            const idx = all.findIndex(x=> x.id === note.id);
            if(idx>-1){ 
                all[idx].text = newText; 
                all[idx].createdAt = Date.now(); // Tarixi yenilə
                save(keyNotes, all); 
                renderNotes(); // Təkrar çək ki, tarix yenilənsin
                toast('Qeyd yadda saxlanıldı'); 
            }
        });

        // Ləğv et
        btnCancel.addEventListener('click', ()=>{
            textarea.value = textarea.dataset.originalText;
            textarea.disabled = true; 
            btnSave.style.display='none'; 
            btnCancel.style.display='none';
            btnEdit.style.display='inline-flex';
            dateSpan.textContent = 'Əlavə edilib: ' + dateFormatter.format(note.createdAt); // Tarixi bərpa et
        });

        // Sil
        btnDelete.addEventListener('click', ()=>{
          const all = load(keyNotes, []);
          save(keyNotes, all.filter(x=> x.id !== note.id));
          renderNotes(); 
          toast('Qeyd silindi');
        });
      }
    }

    document.getElementById('add-note').addEventListener('click', ()=>{
      const t = document.getElementById('note-text');
      const text = t.value.trim(); 
      if(!text){ toast('Mətn boşdur'); return; }
      
      const all = load(keyNotes, []);
      // Yeni qeyd ən üstdə görünməsi üçün unshift istifadə olunur
      all.unshift({ id: 'n'+Date.now(), text, createdAt: Date.now() });
      save(keyNotes, all); 
      t.value=''; 
      renderNotes(); 
      toast('Qeyd əlavə olundu');
    });

    // İlk yüklənmə: Kalkulyator modulları özləri yüklənir, biz yalnız Qeydləri çağırırıq
    (function init(){
      renderNotes();
    })();
  </script>
</body>
</html>
